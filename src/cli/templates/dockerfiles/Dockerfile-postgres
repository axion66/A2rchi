# syntax=docker/dockerfile:1
# PostgreSQL 17 with pgvector + pg_textsearch for archi
# Uses official pgvector image which includes properly compiled pgvector
# Provides: vector similarity search (pgvector), BM25 search (pg_textsearch), encryption (pgcrypto), fuzzy matching (pg_trgm)

# Use official pgvector image - pre-built with pgvector properly compiled
# This avoids ARM64 compilation issues we encountered with manual builds
FROM docker.io/pgvector/pgvector:pg17

# pg_textsearch version - enabled by default for BM25 hybrid search
ARG PGTEXTSEARCH_VERSION=0.4.2

# Install pg_textsearch (BM25) - required for proper hybrid search
RUN apt-get update && apt-get install -y --no-install-recommends curl ca-certificates unzip \
    && cd /tmp \
    && ARCH=$(dpkg --print-architecture) \
    && if [ "$ARCH" = "arm64" ]; then \
         ARCH_SUFFIX="arm64"; \
       else \
         ARCH_SUFFIX="amd64"; \
       fi \
    && curl -fLO "https://github.com/timescale/pg_textsearch/releases/download/v${PGTEXTSEARCH_VERSION}/pg-textsearch-v${PGTEXTSEARCH_VERSION}-pg17-${ARCH_SUFFIX}.zip" \
    && unzip pg-textsearch-*.zip \
    && dpkg -i pg-textsearch-postgresql-17_*.deb \
    && rm -rf /tmp/pg-textsearch* \
    && apt-get remove -y curl unzip \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/* \
    && echo "pg_textsearch ${PGTEXTSEARCH_VERSION} installed"

# Verify extensions are available
RUN postgres --version && \
    ls $(pg_config --pkglibdir)/vector.so && \
    ls $(pg_config --sharedir)/extension/vector.control && \
    echo "pgvector installed successfully" && \
    ls $(pg_config --sharedir)/extension/pg_textsearch.control && \
    echo "pg_textsearch installed successfully"
