name: Test and Build Tag

env:
  ARCHI_DIR: ${{ github.workspace }}/archi-local
  REGISTRY_PREFIX: a2rchi

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Branch or commit to release
        required: false
        default: main
      tag_name:
        description: Tag to create (e.g. v1.2.3)
        required: true

permissions:
  contents: write

jobs:
  build-images:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      clean: ${{ steps.version.outputs.clean }}
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY" || true
          docker system prune -af || true
          df -h /

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || 'main' }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: buildx-release-${{ runner.os }}-${{ hashFiles('requirements/**', 'src/cli/templates/dockerfiles/**/Dockerfile') }}
          restore-keys: buildx-release-${{ runner.os }}-

      - name: Determine release version
        id: version
        run: |
          TAG="${{ inputs.tag_name }}"
          CLEAN="${TAG#v}"
          if [[ -z "$CLEAN" ]]; then
            echo "Unable to derive version from tag '$TAG'" >&2
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "clean=$CLEAN" >> "$GITHUB_OUTPUT"

      - name: Install CLI dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ".[all]" || pip install .

      - name: Ensure build scripts are executable
        run: chmod +x scripts/dev/*.sh

      - name: Build Docker base images
        run: scripts/dev/build_docker_images.sh "${{ steps.version.outputs.tag }}"

      - name: Push versioned base images
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          PUSH_LATEST: "false"
        run: scripts/dev/push_docker_images.sh "${{ steps.version.outputs.tag }}"

  smoke-test:
    runs-on: ubuntu-latest
    needs: build-images
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY" || true
          docker system prune -af || true
          df -h /

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || 'main' }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install CLI dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ".[all]" || pip install .

      - name: Ensure scripts are executable
        run: chmod +x scripts/dev/*.sh

      - name: Install Ollama and pull model
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          for i in $(seq 1 30); do
            if curl -fsS http://localhost:11434/api/tags >/dev/null 2>&1; then
              echo "Ollama is ready"
              break
            fi
            sleep 1
          done
          ollama pull qwen3:4b

      - name: Disable Docker containerd image store
        run: |
          echo '{"features":{"containerd-snapshotter":false}}' | sudo tee /etc/docker/daemon.json
          sudo rm -rf /etc/docker/daemon.json.d
          sudo systemctl restart docker
          docker info | grep -i "Storage Driver"

      - name: Point Dockerfiles to versioned base images
        run: python scripts/dev/update_service_base_images.py --tag "${{ needs.build-images.outputs.tag }}" --switch-source dockerhub

      - name: Run smoke deployment
        uses: ./.github/actions/run-smoke
        with:
          deployment-name: release-${{ github.run_id }}
          extra-env: |
            ARCHI_COMPOSE_UP_FLAGS=--build --pull
            SMOKE_OLLAMA_MODEL=qwen3:4b
            SMOKE_OLLAMA_URL=http://localhost:11434
            SMOKE_OLLAMA_HOST=http://localhost:11434
          config-path: tests/pr_preview_config/pr_preview_config.yaml
          config-destination: configs/ci/ci_config.generated.yaml
          services: chatbot
          hostmode: "true"
          wait-url: http://localhost:2786/api/health
          base-url: http://localhost:2786
          use-podman: "false"

      - name: Commit Dockerfile base image updates
        if: success()
        env:
          TARGET_REF: ${{ inputs.ref || 'main' }}
          VERSION_TAG: ${{ needs.build-images.outputs.tag }}
        run: |
          set -euo pipefail
          CHANGED_FILES="$(git diff --name-only | grep -E '(^|/)Dockerfile' || true)"
          if [ -z "$CHANGED_FILES" ]; then
            echo "No Dockerfile updates to commit"
          else
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git config user.name "github-actions[bot]"
            printf '%s\n' "$CHANGED_FILES" | xargs git add
            git commit -m "chore: update Dockerfiles for ${VERSION_TAG}"
            git push origin HEAD:"${TARGET_REF}"
          fi

      - name: Prune Docker cache
        if: always()
        run: |
          docker system prune -af || true
          docker volume prune -f || true

  release:
    runs-on: ubuntu-latest
    needs: [build-images, smoke-test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || 'main' }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Promote Docker images to latest
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          VERSION_TAG: ${{ needs.build-images.outputs.tag }}
          REGISTRY_PREFIX: ${{ env.REGISTRY_PREFIX }}
        run: |
          set -euo pipefail
          echo "$DOCKERHUB_TOKEN" | docker login docker.io --username "$DOCKERHUB_USERNAME" --password-stdin
          for image in ${REGISTRY_PREFIX}/archi-python-base ${REGISTRY_PREFIX}/archi-pytorch-base; do
            # Pull the versioned image and re-tag as latest
            docker pull "docker.io/$image:$VERSION_TAG"
            docker tag "docker.io/$image:$VERSION_TAG" "docker.io/$image:latest"
            docker push "docker.io/$image:latest"
          done
      - name: Update version in project files
        run: python scripts/dev/update_version.py "${{ needs.build-images.outputs.clean }}"
      - name: Commit version bump
        env:
          VERSION_CLEAN: ${{ needs.build-images.outputs.clean }}
          TARGET_REF: ${{ inputs.ref || 'main' }}
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "Version files already set to ${VERSION_CLEAN}"
          else
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git config user.name "github-actions[bot]"
            git add pyproject.toml docs/mkdocs.yml
            git commit -m "chore: bump version to ${VERSION_CLEAN}"
            git push origin HEAD:"${TARGET_REF}"
          fi

      - name: Create Git tag
        env:
          TAG_NAME: ${{ needs.build-images.outputs.tag }}
        run: |
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists locally." >&2
            exit 1
          fi
          if git ls-remote --tags origin "$TAG_NAME" | grep "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists on origin." >&2
            exit 1
          fi
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"
