version: "3.8"

# Docker Compose for PostgreSQL Consolidation Integration Testing
# 
# Starts minimal services needed to test:
# - PostgreSQL with pgvector, pgcrypto
# - Chat service
# - Data manager (for ingestion testing)
#
# Usage:
#   cd tests/smoke
#   docker compose -f docker-compose.integration.yaml up -d
#   python test_integration.py
#   docker compose -f docker-compose.integration.yaml down -v

services:
  postgres:
    image: pgvector/pgvector:pg17
    container_name: a2rchi-test-postgres
    environment:
      POSTGRES_USER: a2rchi
      POSTGRES_PASSWORD: testpassword123
      POSTGRES_DB: a2rchi
    ports:
      - "5439:5432"  # Use non-standard port to avoid conflicts
    volumes:
      - ./init-test.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U a2rchi -d a2rchi"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - a2rchi-test

networks:
  a2rchi-test:
    driver: bridge
