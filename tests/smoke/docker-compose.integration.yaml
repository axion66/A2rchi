version: "3.8"

# Docker Compose for PostgreSQL Integration Testing (pytest)
# 
# PURPOSE: Provides an isolated PostgreSQL instance for pytest-based integration
# tests (test_integration.py, test_postgres_consolidation.py). This is separate
# from scripts/dev/run_smoke_preview.sh which tests full CLI deployment workflows.
#
# Starts minimal services needed to test:
# - PostgreSQL with pgvector, pgcrypto
#
# Usage:
#   cd tests/smoke
#   docker compose -f docker-compose.integration.yaml up -d
#   pytest test_integration.py -v
#   docker compose -f docker-compose.integration.yaml down -v
#
# Note: Uses port 5439 to avoid conflicts with local PostgreSQL installations.

services:
  postgres:
    image: pgvector/pgvector:pg17
    container_name: archi-test-postgres
    environment:
      POSTGRES_USER: archi
      POSTGRES_PASSWORD: testpassword123
      POSTGRES_DB: archi
    ports:
      - "5439:5432"  # Use non-standard port to avoid conflicts
    volumes:
      - ./init-test.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U archi -d archi"]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - archi-test

  grafana:
    image: grafana/grafana:11.0.0
    container_name: archi-test-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    ports:
      - "3001:3000"  # Use non-standard port to avoid conflicts
    volumes:
      - ./grafana-provisioning:/etc/grafana/provisioning:ro
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - archi-test

networks:
  archi-test:
    driver: bridge
